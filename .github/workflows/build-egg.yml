name: Build Bluefin Egg

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 08:00 UTC, after GNOME OS builds (~03:03) and source tracking (06:00)
  workflow_dispatch:

env:
  IMAGE_NAME: egg
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}

# Only one build at a time. If a manual dispatch arrives while a scheduled
# build is running, the in-progress run is cancelled.
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Get JWT token
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const token = await core.getIDToken('cache.projectbluefin.io')
            fs.writeFileSync('bluefin.token', token, { mode: 0o600 });

      - name: Setup Just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Capture build timestamp
        id: timestamp
        run: echo "created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      # ── Generate CI-specific BuildStream config ───────────────────────
      # Tuned per gnome-build-meta CI patterns:
      # - on-error: continue  -> find ALL failures, don't stop at first
      # - fetchers: 32        -> parallel downloads from upstream caches
      # - builders: 0         -> Concurrent builds are controlled in the casd server
      # - retry-failed: True  -> auto-retry flaky builds
      # - error-lines: 80     -> generous error context in logs
      # - cache-buildtrees: never -> save disk (we only need final artifacts)
      #
      - name: Generate BuildStream CI config
        run: |
          mkdir -p logs
          builders="$(( $(nproc) / 4 ))"
          # Setup certificate for pushing to the cache
          echo "$CASD_CLIENT_CERT" > client.crt
          echo "$CASD_CLIENT_KEY" > client.key
          cat > buildstream-ci.conf <<'BSTCONF'
          scheduler:
            on-error: continue
            fetchers: 32
            builders: 4
            network-retries: 3

          logging:
            message-format: '[%{wallclock}][%{elapsed}][%{key}][%{element}] %{action} %{message}'
            error-lines: 80

          cachedir: /tmp/cache
          logdir: /src/logs

          build:
            retry-failed: True

          artifacts:
            # override-project-caches: true
            servers:
            - url: https://cache.projectbluefin.io:11004
              push: true
              connection-config:
                keepalive-time: 60
                retry-limit: 5
                retry-delay: 500
                request-timeout: 180
              auth:
                client-key: /src/client.key
                client-cert: /src/client.crt

          source-caches:
            # override-project-caches: true
            servers:
            - url: https://cache.projectbluefin.io:11004
              push: true
              connection-config:
                keepalive-time: 60
                retry-limit: 5
                retry-delay: 500
                request-timeout: 180
              auth:
                client-key: /src/client.key
                client-cert: /src/client.crt

          cache:
            storage-service:
              url: https://cache.projectbluefin.io:11004
              connection-config:
                keepalive-time: 60
                retry-limit: 5
                retry-delay: 500
                request-timeout: 180
              auth:
                client-key: /src/client.key
                client-cert: /src/client.crt

          remote-execution:
            execution-service:
              url: https://cache.projectbluefin.io:11004
              connection-config:
                keepalive-time: 60
                retry-limit: 5
                retry-delay: 500
                request-timeout: 180
              auth:
                client-key: /src/client.key
                client-cert: /src/client.crt
            action-cache-service:
              url: https://cache.projectbluefin.io:11004
              connection-config:
                keepalive-time: 60
                retry-limit: 5
                retry-delay: 500
                request-timeout: 180
              auth:
                client-key: /src/client.key
                client-cert: /src/client.crt
          BSTCONF

          echo "=== BuildStream CI config ==="
          cat buildstream-ci.conf

      # ── BuildStream build ─────────────────────────────────────────────
      # Uses the Justfile's `bst` wrapper to run BuildStream inside the
      # bst2 container. CI-specific flags (--no-interactive, --config)
      # are injected via BST_FLAGS env var.

      - name: Build OCI image with BuildStream
        env:
          BST_FLAGS: --no-interactive --config /src/buildstream-ci.conf
        run: |
          just bst build oci/bluefin.bst
        timeout-minutes: 120

      # ── Export OCI image ──────────────────────────────────────────────
      # Uses the Justfile's `export` recipe: checks out the OCI image
      # layout from BuildStream, loads it into podman via skopeo, and
      # applies the /usr/etc bootc fixup. Same logic as local builds.
      # Creates image with local name (egg:latest) to avoid registry
      # lookups during validation.

      - name: Export OCI image from BuildStream
        id: export
        env:
          BST_FLAGS: --no-interactive --config /src/buildstream-ci.conf
          BUILD_IMAGE_NAME: ${{ env.IMAGE_NAME }}
          OCI_IMAGE_CREATED: ${{ steps.timestamp.outputs.created }}
          OCI_IMAGE_REVISION: ${{ github.sha }}
          OCI_IMAGE_VERSION: latest
        run: |
          just export
          echo "image_ref=${{ env.IMAGE_NAME }}:latest" >> "$GITHUB_OUTPUT"

      - name: Verify image loaded
        run: sudo podman images

      # ── Validation ────────────────────────────────────────────────────

      - name: Validate with bootc container lint
        run: |
           just lint

      # Delete jwt token just in case
      - name: Delete token
        if: always()
        run: rm -f bluefin.token

      # ── Upload build logs ─────────────────────────────────────────────
      # Always upload, even on failure, so build failures can be diagnosed.

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: buildstream-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      # ── Publish to GHCR ───────────────────────────────────────────────

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            sudo podman login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Tag image for GHCR
        run: |
          sudo podman tag "localhost/${{ steps.export.outputs.image_ref }}" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          sudo podman tag "localhost/${{ steps.export.outputs.image_ref }}" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      - name: Push to GHCR
        run: |
          for tag in latest "${{ github.sha }}"; do
            for i in 1 2 3; do
              sudo podman push "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${tag}" && break
              echo "Push attempt $i failed for tag ${tag}, retrying..."
              sleep 5
            done
          done
