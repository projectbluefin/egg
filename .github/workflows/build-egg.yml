name: Build Bluefin Egg

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 08:00 UTC, after GNOME OS builds (~03:03) and source tracking (06:00)
  workflow_dispatch:

env:
  IMAGE_NAME: egg
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  BST2_IMAGE: registry.gitlab.com/freedesktop-sdk/infrastructure/freedesktop-sdk-docker-images/bst2:f89b4aef847ef040b345acceda15a850219eb8f1

# Only one build at a time. If a manual dispatch arrives while a scheduled
# build is running, the in-progress run is cancelled.
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4


      - name: Pull BuildStream container image
        run: podman pull "$BST2_IMAGE"

      - name: Mount BuildStream cache (sticky disk)
        uses: useblacksmith/stickydisk@18dec295a653142036063064b24678d434710e56 # v1
        with:
          key: ${{ github.repository }}-bst-cache
          path: /home/runner/.cache/buildstream

      - name: Prepare BuildStream cache layout
        run: |
          mkdir -p /home/runner/.cache/buildstream/{cas,artifacts,source_protos,sources}
          echo "=== Sticky disk status ==="
          du -sh /home/runner/.cache/buildstream/{cas,artifacts,source_protos,sources} 2>/dev/null || true
          df -h /home/runner/.cache/buildstream

      - name: Setup Just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Capture build timestamp
        id: timestamp
        run: echo "created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      # ── Generate CI-specific BuildStream config ───────────────────────
      # Tuned per gnome-build-meta CI patterns:
      # - on-error: continue  -> find ALL failures, don't stop at first
      # - fetchers: 12        -> parallel downloads from upstream caches
      # - builders: 1         -> conservative to avoid OOM
      # - retry-failed: True  -> auto-retry flaky builds
      # - error-lines: 80     -> generous error context in logs
      # - cache-buildtrees: never -> save disk (we only need final artifacts)
      #
      # No remote artifact server is configured. BuildStream uses only:
      # 1. Local disk cache (persisted by sticky disk)
      # 2. Upstream GNOME caches defined in project.conf (read-only)

      - name: Generate BuildStream CI config
        run: |
          mkdir -p logs
          cat > buildstream-ci.conf <<'BSTCONF'
          scheduler:
            on-error: continue
            fetchers: 12
            builders: 1
            network-retries: 3

          logging:
            message-format: '[%{wallclock}][%{elapsed}][%{key}][%{element}] %{action} %{message}'
            error-lines: 80

          build:
            max-jobs: 0
            retry-failed: True

          cache:
            cache-buildtrees: never
          BSTCONF

          echo "=== BuildStream CI config ==="
          cat buildstream-ci.conf

      # ── BuildStream build ─────────────────────────────────────────────
      # Uses the Justfile's `bst` wrapper to run BuildStream inside the
      # bst2 container. CI-specific flags (--no-interactive, --config)
      # are injected via BST_FLAGS env var.
      # Additional --log-file flag is passed directly (build-specific).

      - name: Build OCI image with BuildStream
        env:
          BST_FLAGS: --no-interactive --config /src/buildstream-ci.conf
        run: |
          just bst --log-file /src/logs/build.log build oci/bluefin.bst
        timeout-minutes: 120

      - name: Cache and disk status
        if: always()
        run: |
          echo "=== Disk usage ==="
          df -h /home/runner/.cache/buildstream / 2>/dev/null || df -h /
          echo ""
          echo "=== BuildStream cache breakdown ==="
          du -sh /home/runner/.cache/buildstream/{cas,artifacts,source_protos,sources} 2>/dev/null || true
          echo ""
          echo "=== Total ==="
          du -sh /home/runner/.cache/buildstream/ 2>/dev/null || true

      # ── Export OCI image ──────────────────────────────────────────────
      # Uses the Justfile's `export` recipe: checks out the OCI image
      # layout from BuildStream, loads it into podman via skopeo, and
      # applies the /usr/etc bootc fixup. Same logic as local builds.
      # Creates image with local name (egg:latest) to avoid registry
      # lookups during validation.

      - name: Export OCI image from BuildStream
        id: export
        env:
          BST_FLAGS: --no-interactive --config /src/buildstream-ci.conf
          BUILD_IMAGE_NAME: ${{ env.IMAGE_NAME }}
          OCI_IMAGE_CREATED: ${{ steps.timestamp.outputs.created }}
          OCI_IMAGE_REVISION: ${{ github.sha }}
          OCI_IMAGE_VERSION: latest
        run: |
          just export
          echo "image_ref=${{ env.IMAGE_NAME }}:latest" >> "$GITHUB_OUTPUT"

      - name: Verify image loaded
        run: sudo podman images

      # ── Validation ────────────────────────────────────────────────────

      - name: Validate with bootc container lint
        run: |
           just lint

      # ── Upload build logs ─────────────────────────────────────────────
      # Always upload, even on failure, so build failures can be diagnosed.

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: buildstream-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      # ── Publish to GHCR ───────────────────────────────────────────────

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            sudo podman login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Tag image for GHCR
        run: |
          sudo podman tag "localhost/${{ steps.export.outputs.image_ref }}" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          sudo podman tag "localhost/${{ steps.export.outputs.image_ref }}" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      - name: Push to GHCR
        run: |
          for tag in latest "${{ github.sha }}"; do
            for i in 1 2 3; do
              sudo podman push "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${tag}" && break
              echo "Push attempt $i failed for tag ${tag}, retrying..."
              sleep 5
            done
          done
