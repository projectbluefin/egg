name: Build Bluefin Egg (Multi-Runner)

# Multi-runner build for free GitHub-hosted runners (no Blacksmith).
# Splits the BuildStream dependency graph into parallel chunks, caches
# each chunk as a GHCR OCI artifact (via ORAS), and skips chunks that
# haven't changed. Uses zstd compression for faster transfers.

on:
  workflow_dispatch:

env:
  IMAGE_NAME: egg
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  BST2_IMAGE: registry.gitlab.com/freedesktop-sdk/infrastructure/freedesktop-sdk-docker-images/bst2:f89b4aef847ef040b345acceda15a850219eb8f1
  NUM_CHUNKS: "10"
  CORE_SPLIT: "200"

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: true

jobs:
  # ── Phase 1: Plan the build ──────────────────────────────────────────
  # Runs `bst show` to discover which elements need building, splits them
  # into chunks, and computes a cache key for each chunk.
  planning:
    runs-on: ubuntu-24.04
    outputs:
      matrix_keys: ${{ steps.matrix.outputs.matrix_keys }}
      matrix_data: ${{ steps.matrix.outputs.matrix_data }}
      cache_keys: ${{ steps.matrix.outputs.cache_keys }}
      core_targets: ${{ steps.matrix.outputs.core_targets }}
      final_target: ${{ steps.matrix.outputs.final_target }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - run: podman pull "$BST2_IMAGE"

      - name: Setup Just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Cache BuildStream sources
        uses: actions/cache@v4
        with:
          path: .cache/buildstream/sources
          key: bst-sources-${{ runner.os }}-${{ hashFiles('project.conf', 'elements/**/*.bst') }}
          restore-keys: |
            bst-sources-${{ runner.os }}-

      - name: Generate Build Matrix
        id: matrix
        env:
          BST_FLAGS: --no-interactive
        run: |
          mkdir -p .cache/buildstream logs

          # Generate the build plan and matrix inside the bst2 container
          just bst show --deps all --order stage \
            --format '%{name}||%{state}||%{full-key}' oci/bluefin.bst \
            > /dev/null 2>&1 || true

          # Run planning script
          podman run --rm --privileged --device /dev/fuse \
            --security-opt apparmor=unconfined --cap-add SYS_ADMIN \
            -v "${{ github.workspace }}:/src:rw" \
            -v "${{ github.workspace }}/.cache/buildstream:/root/.cache/buildstream:rw" \
            -w /src \
            "$BST2_IMAGE" \
            python3 /src/scripts/ci-build-matrix.py oci/bluefin.bst \
              "$NUM_CHUNKS" "$CORE_SPLIT" > matrix.json

          cat matrix.json

          # Parse outputs for GitHub Actions
          python3 -c "
          import json
          data = json.load(open('matrix.json'))
          keys = list(data['matrix'].keys())
          print(f'matrix_keys={json.dumps(keys)}')
          print(f'matrix_data={json.dumps(data[\"matrix\"])}')
          print(f'cache_keys={json.dumps(data.get(\"cache_keys\", {}))}')
          print(f'core_targets={data.get(\"core\", \"\")}')
          print(f'final_target={data[\"final\"]}')
          " >> "$GITHUB_OUTPUT"

      - name: Upload planning logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: planning-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

  # ── Phase 2: Build core (bootstrap) elements ─────────────────────────
  build_core:
    needs: planning
    if: needs.planning.outputs.core_targets != ''
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    permissions:
      contents: read
      packages: write
    env:
      TARGETS: ${{ needs.planning.outputs.core_targets }}
    steps:
      - name: Free disk space
        uses: ublue-os/remove-unwanted-software@695eb75bc387dbcd9685a8e72d23439d8686cba6

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - run: podman pull "$BST2_IMAGE"

      - name: Setup Just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Setup ORAS
        uses: oras-project/setup-oras@v1

      - name: Cache BuildStream sources
        uses: actions/cache@v4
        with:
          path: .cache/buildstream/sources
          key: bst-sources-${{ runner.os }}-${{ hashFiles('project.conf', 'elements/**/*.bst') }}
          restore-keys: |
            bst-sources-${{ runner.os }}-

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Restore Core Cache from GHCR
        run: |
          mkdir -p ~/.cache/buildstream
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          CORE_REF="ghcr.io/${REPO_LOWER}/cache-core:latest"

          if oras pull "$CORE_REF" -o .; then
            if [ -f cas-core.tar.zst ]; then
              zstd -d -T0 cas-core.tar.zst -o cas-core.tar
              tar -xf cas-core.tar -C "$HOME/.cache/buildstream"
              rm -f cas-core.tar cas-core.tar.zst
              echo "Core CAS warmed."
            else
              echo "WARNING: No cas-core.tar.zst in artifact. Ignoring cache."
            fi
          else
            echo "No existing core cache found, starting fresh."
          fi

      - name: Generate CI config
        run: |
          mkdir -p logs
          cat > buildstream-ci.conf <<'BSTCONF'
          scheduler:
            on-error: continue
            fetchers: 12
            builders: 1
            network-retries: 3
          logging:
            message-format: '[%{wallclock}][%{elapsed}][%{key}][%{element}] %{action} %{message}'
            error-lines: 80
          build:
            max-jobs: 0
            retry-failed: True
          cache:
            cache-buildtrees: never
          BSTCONF

      - name: Build Core
        env:
          BST_FLAGS: --no-interactive --config /src/buildstream-ci.conf
        run: |
          just bst --log-file /src/logs/build-core.log build $TARGETS

      - name: Archive and Push Core CAS
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          CORE_REF="ghcr.io/${REPO_LOWER}/cache-core:latest"

          # Archive CAS with zstd compression
          podman run --rm \
            -v "$HOME/.cache/buildstream:/input:ro" \
            -v "${{ github.workspace }}:/output:rw" \
            "$BST2_IMAGE" \
            sh -c "tar -cf /output/cas-core.tar -C /input --exclude 'cas/staging' --exclude 'cas/tmp' . || [ \$? -eq 1 ]"

          zstd -T0 --rm cas-core.tar -o cas-core.tar.zst
          echo "Compressed CAS archive: $(du -sh cas-core.tar.zst | cut -f1)"

          # Push to GHCR as an OCI artifact
          oras push "$CORE_REF" cas-core.tar.zst:application/vnd.buildstream.cas.tar.zst
          echo "Pushed core CAS to $CORE_REF"

  # ── Phase 3: Build dependency chunks in parallel ─────────────────────
  build_deps:
    needs: [planning, build_core]
    if: always() && !contains(needs.*.result, 'failure') && needs.planning.outputs.matrix_keys != '[]'
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        chunk: ${{ fromJson(needs.planning.outputs.matrix_keys) }}
    env:
      TARGETS: ${{ fromJson(needs.planning.outputs.matrix_data)[matrix.chunk] }}
      CHUNK_CACHE_KEY: ${{ fromJson(needs.planning.outputs.cache_keys)[matrix.chunk] }}
    name: Build ${{ matrix.chunk }}
    steps:
      - name: Free disk space
        uses: ublue-os/remove-unwanted-software@695eb75bc387dbcd9685a8e72d23439d8686cba6

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - run: podman pull "$BST2_IMAGE"

      - name: Setup Just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Setup ORAS
        uses: oras-project/setup-oras@v1

      - name: Cache BuildStream sources
        uses: actions/cache@v4
        with:
          path: .cache/buildstream/sources
          key: bst-sources-${{ runner.os }}-${{ hashFiles('project.conf', 'elements/**/*.bst') }}
          restore-keys: |
            bst-sources-${{ runner.os }}-

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io -u ${{ github.actor }} --password-stdin

      # ── Cache-aware skip: check if this chunk is already in GHCR ────
      - name: Check GHCR for cached chunk
        id: cache_check
        if: env.CHUNK_CACHE_KEY != '' && env.CHUNK_CACHE_KEY != 'null'
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          CHUNK_REF="ghcr.io/${REPO_LOWER}/cache-${{ matrix.chunk }}:${CHUNK_CACHE_KEY}"

          echo "Checking for cached chunk: $CHUNK_REF"
          if oras manifest fetch "$CHUNK_REF" > /dev/null 2>&1; then
            echo "cache_hit=true" >> "$GITHUB_OUTPUT"
            echo "✅ Cache hit! Skipping build for ${{ matrix.chunk }}"
          else
            echo "cache_hit=false" >> "$GITHUB_OUTPUT"
            echo "❌ Cache miss for ${{ matrix.chunk }}, will build"
          fi

      - name: Restore Core Cache
        if: steps.cache_check.outputs.cache_hit != 'true'
        run: |
          mkdir -p ~/.cache/buildstream
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          CORE_REF="ghcr.io/${REPO_LOWER}/cache-core:latest"

          if oras pull "$CORE_REF" -o .; then
            if [ -f cas-core.tar.zst ]; then
              zstd -d -T0 cas-core.tar.zst -o cas-core.tar
              tar -xf cas-core.tar -C "$HOME/.cache/buildstream"
              rm -f cas-core.tar cas-core.tar.zst
              echo "Core CAS warmed."
            fi
          fi

      - name: Restore Chunk Cache (fallback to latest)
        id: restore
        if: steps.cache_check.outputs.cache_hit != 'true'
        continue-on-error: true
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          LATEST_REF="ghcr.io/${REPO_LOWER}/cache-${{ matrix.chunk }}:latest"

          if oras pull "$LATEST_REF" -o .; then
            if [ -f cas-${{ matrix.chunk }}.tar.zst ]; then
              echo "Warming CAS from latest cache..."
              mkdir -p ~/.cache/buildstream
              zstd -d -T0 cas-${{ matrix.chunk }}.tar.zst -o cas-${{ matrix.chunk }}.tar
              tar -xf cas-${{ matrix.chunk }}.tar -C "$HOME/.cache/buildstream"
              rm -f cas-${{ matrix.chunk }}.tar cas-${{ matrix.chunk }}.tar.zst
              echo "CAS warmed from latest."
            fi
          fi

      - name: Generate CI config
        if: steps.cache_check.outputs.cache_hit != 'true'
        run: |
          mkdir -p logs
          cat > buildstream-ci.conf <<'BSTCONF'
          scheduler:
            on-error: continue
            fetchers: 12
            builders: 1
            network-retries: 3
          logging:
            message-format: '[%{wallclock}][%{elapsed}][%{key}][%{element}] %{action} %{message}'
            error-lines: 80
          build:
            max-jobs: 0
            retry-failed: True
          cache:
            cache-buildtrees: never
          BSTCONF

      - name: Build Chunk
        id: build
        if: steps.cache_check.outputs.cache_hit != 'true'
        env:
          BST_FLAGS: --no-interactive --config /src/buildstream-ci.conf
        run: |
          if [ -z "$TARGETS" ]; then
            echo "No targets for this chunk, skipping."
            echo "skipped=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mkdir -p ~/.cache/buildstream
          max_retries=3
          count=0
          success=false
          while [ $count -lt $max_retries ]; do
            if just bst --log-file /src/logs/build-${{ matrix.chunk }}.log build $TARGETS; then
              success=true
              break
            fi
            echo "Build failed, retrying in 10s... ($((count+1))/$max_retries)"
            count=$((count+1))
            sleep 10
          done

          if [ "$success" = "false" ]; then
            echo "Build failed after $max_retries attempts."
            exit 1
          fi

      - name: Archive and Push CAS to GHCR
        if: always() && steps.cache_check.outputs.cache_hit != 'true' && steps.build.outputs.skipped != 'true' && env.CHUNK_CACHE_KEY != '' && env.CHUNK_CACHE_KEY != 'null'
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          CHUNK_REF="ghcr.io/${REPO_LOWER}/cache-${{ matrix.chunk }}:${CHUNK_CACHE_KEY}"
          LATEST_REF="ghcr.io/${REPO_LOWER}/cache-${{ matrix.chunk }}:latest"

          # Archive CAS with zstd compression
          podman run --rm \
            -v "$HOME/.cache/buildstream:/input:ro" \
            -v "${{ github.workspace }}:/output:rw" \
            "$BST2_IMAGE" \
            sh -c "tar -cf /output/cas-${{ matrix.chunk }}.tar -C /input --exclude 'cas/staging' --exclude 'cas/tmp' . || [ \$? -eq 1 ]"

          zstd -T0 --rm cas-${{ matrix.chunk }}.tar -o cas-${{ matrix.chunk }}.tar.zst
          echo "Compressed CAS archive: $(du -sh cas-${{ matrix.chunk }}.tar.zst | cut -f1)"

          # Push to GHCR as OCI artifact — always update :latest
          oras push "$LATEST_REF" cas-${{ matrix.chunk }}.tar.zst:application/vnd.buildstream.cas.tar.zst
          echo "Pushed latest cache: $LATEST_REF"

          # If build succeeded, also tag with the strict cache key
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            oras push "$CHUNK_REF" cas-${{ matrix.chunk }}.tar.zst:application/vnd.buildstream.cas.tar.zst
            echo "Pushed strict cache: $CHUNK_REF"
          fi

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: build-logs-${{ matrix.chunk }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

  # ── Phase 4: Final assembly ──────────────────────────────────────────
  build_final:
    needs: [planning, build_deps]
    if: always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Free disk space
        uses: ublue-os/remove-unwanted-software@695eb75bc387dbcd9685a8e72d23439d8686cba6

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Checkout chunkah
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: coreos/chunkah
          path: chunkah

      - run: podman pull "$BST2_IMAGE"

      - name: Setup Just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Setup ORAS
        uses: oras-project/setup-oras@v1

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Download and Merge CAS Chunks from GHCR
        env:
          MATRIX_KEYS: ${{ needs.planning.outputs.matrix_keys }}
          CACHE_KEYS: ${{ needs.planning.outputs.cache_keys }}
        run: |
          mkdir -p ~/.cache/buildstream

          # First, restore core CAS
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          CORE_REF="ghcr.io/${REPO_LOWER}/cache-core:latest"
          echo "Restoring core CAS..."
          if oras pull "$CORE_REF" -o .; then
            if [ -f cas-core.tar.zst ]; then
              zstd -d -T0 cas-core.tar.zst -o cas-core.tar
              tar -xf cas-core.tar -C "$HOME/.cache/buildstream"
              rm -f cas-core.tar cas-core.tar.zst
              echo "Core CAS restored."
            fi
          fi

          # Then, restore each chunk CAS
          echo "Processing chunks..."
          echo "$MATRIX_KEYS" | jq -r '.[]' | while read -r chunk; do
            # Try the strict cache key first, fall back to latest
            CACHE_KEY=$(echo "$CACHE_KEYS" | jq -r --arg c "$chunk" '.[$c] // empty')
            PULLED=false

            if [ -n "$CACHE_KEY" ]; then
              STRICT_REF="ghcr.io/${REPO_LOWER}/cache-${chunk}:${CACHE_KEY}"
              echo "Trying strict cache: $STRICT_REF"
              if oras pull "$STRICT_REF" -o .; then
                PULLED=true
              fi
            fi

            if [ "$PULLED" = "false" ]; then
              LATEST_REF="ghcr.io/${REPO_LOWER}/cache-${chunk}:latest"
              echo "Falling back to latest: $LATEST_REF"
              oras pull "$LATEST_REF" -o . || {
                echo "WARNING: Failed to pull cache for $chunk, skipping"
                continue
              }
            fi

            # Find and extract the CAS tarball
            TARBALL="cas-${chunk}.tar.zst"
            if [ -f "$TARBALL" ]; then
              echo "Extracting $TARBALL..."
              zstd -d -T0 "$TARBALL" -o "cas-${chunk}.tar"
              tar -xf "cas-${chunk}.tar" -C "$HOME/.cache/buildstream"
              rm -f "$TARBALL" "cas-${chunk}.tar"
            else
              echo "WARNING: No $TARBALL found after pull, skipping"
            fi
          done

          echo "CAS merge complete."
          du -sh ~/.cache/buildstream

      - name: Generate CI config
        run: |
          mkdir -p logs
          cat > buildstream-ci.conf <<'BSTCONF'
          scheduler:
            on-error: continue
            fetchers: 12
            builders: 1
            network-retries: 3
          logging:
            message-format: '[%{wallclock}][%{elapsed}][%{key}][%{element}] %{action} %{message}'
            error-lines: 80
          build:
            max-jobs: 0
            retry-failed: True
          cache:
            cache-buildtrees: never
          BSTCONF

      - name: Build Final Target
        env:
          BST_FLAGS: --no-interactive --config /src/buildstream-ci.conf
        run: |
          just bst --log-file /src/logs/build-final.log build ${{ needs.planning.outputs.final_target }}

      - name: Export OCI image
        id: export
        env:
          BST_FLAGS: --no-interactive --config /src/buildstream-ci.conf
          BUILD_IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          just export
          echo "image_ref=${{ env.IMAGE_NAME }}:latest" >> "$GITHUB_OUTPUT"

      - name: Verify image loaded
        run: sudo podman images

      - name: Validate with bootc container lint
        run: just lint

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: final-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            sudo podman login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Tag and Push to GHCR
        run: |
          sudo podman tag "localhost/${{ steps.export.outputs.image_ref }}" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          sudo podman tag "localhost/${{ steps.export.outputs.image_ref }}" \
            "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          for tag in latest "${{ github.sha }}"; do
            for i in 1 2 3; do
              sudo podman push "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${tag}" && break
              echo "Push attempt $i failed for tag ${tag}, retrying..."
              sleep 5
            done
          done
