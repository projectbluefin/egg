# Ghostty Terminal Emulator Implementation Plan

> **For agents:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add Ghostty (GPU-accelerated terminal emulator) to the Bluefin image alongside the existing Ptyxis terminal, built from source using a pre-built Zig compiler and offline dependency cache.

**Architecture:** Ghostty is built with Zig, which has no presence in freedesktop-sdk or gnome-build-meta. The approach is: (1) fetch a pre-built Zig 0.14.1 binary tarball as a build dependency, (2) fetch the Ghostty source tarball plus all 35 Zig dependencies as separate BST sources, (3) use `zig fetch` on local files to populate the Zig global cache, (4) build with `zig build --system` for a fully offline, sandboxed build. This is the first Zig-built package in this ecosystem.

**Tech Stack:** BuildStream 2, Zig 0.14.1, Ghostty 1.2.3

---

## Context & Discoveries

### Ghostty build requirements

- **Ghostty v1.2.3**: Latest stable. Source tarball includes vendored dependencies list in `build.zig.zon`.
- **Zig 0.14.1**: Required compiler version. Pre-built Linux x86_64 binary available as a self-contained tarball (no system dependencies).
- **35 Zig dependencies**: Listed in `build.zig.zon` with content-addressable hashes. Must be fetched and cached before build.
- **GTK4, libadwaita**: Runtime dependencies already available via gnome-build-meta.
- **No network in sandbox**: BuildStream builds run inside bubblewrap with no network access. All sources must be pre-fetched.

### Source URLs and checksums

**Zig 0.14.1 (x86_64-linux):**
```
URL: https://ziglang.org/download/0.14.1/zig-x86_64-linux-0.14.1.tar.xz
SHA256: 24aeeec8af16c381934a6cd7d95c807a8cb2cf7df9fa40d359aa884195c4716c
```

**Ghostty 1.2.3 source tarball:**
```
URL: https://release.files.ghostty.org/1.2.3/ghostty-1.2.3.tar.gz
```

### Zig dependency list (35 dependencies)

These are all the URLs from Ghostty's `build.zig.zon.txt`. Each must be a separate BST `remote` source so BuildStream can fetch and cache them independently.

**Git-based dependencies (3):**
```
https://github.com/AcademySoftwareFoundation/openexr/archive/refs/tags/v3.3.2.tar.gz
https://github.com/AcademySoftwareFoundation/Imath/archive/refs/tags/v3.1.12.tar.gz
https://github.com/nothings/stb/archive/refs/heads/master.tar.gz
```

**Ghostty deps CDN (24):**
```
https://deps.files.ghostty.org/freetype-VER.tar.gz  (exact URLs from build.zig.zon)
https://deps.files.ghostty.org/fontconfig-VER.tar.gz
https://deps.files.ghostty.org/harfbuzz-VER.tar.gz
https://deps.files.ghostty.org/libpng-VER.tar.gz
https://deps.files.ghostty.org/zlib-VER.tar.gz
https://deps.files.ghostty.org/ziglyph-VER.tar.gz
... (full list in build.zig.zon)
```

**GitHub archive dependencies (8):**
```
https://github.com/AcademySoftwareFoundation/openexr/...
https://github.com/nothings/stb/...
... (full list in build.zig.zon)
```

> **IMPORTANT**: The exact URLs and hashes MUST be extracted from the actual `build.zig.zon` file inside the Ghostty 1.2.3 source tarball at build time. The list above is illustrative. Task 1 includes a step to extract the complete list.

### How `zig fetch` + `--system` works

Zig's build system uses a content-addressable cache at `$ZIG_GLOBAL_CACHE_DIR/p/<hash>/`. The offline build workflow:

1. **`zig fetch <path-to-tarball>`**: Unpacks archive, computes content hash, stores in `$ZIG_GLOBAL_CACHE_DIR/p/<hash>/`. Works with local file paths (no network needed).
2. **`zig build --system <path>`**: Points Zig at a flat directory of hash-named package dirs. Disables all network. The `<path>` should be the `p/` directory inside the cache.
3. **Build command** (from Arch PKGBUILD pattern):
   ```
   ZIG_GLOBAL_CACHE_DIR=/tmp/zig-cache \
   DESTDIR=%{install-root} \
   zig build \
     --prefix /usr \
     --system /tmp/zig-cache/p \
     -Doptimize=ReleaseFast \
     -Dcpu=baseline \
     -Dpie=true
   ```

### BST element patterns in this project

- **Element kinds used**: `manual` (for non-standard build systems), `meson`, `make`, `autotools`, `stack`, `compose`, `script`
- **Source types**: `git_repo`, `tar`, `remote`, `local`, `cargo2`, `patch_queue`
- **Source aliases**: `github:` = `https://github.com/`, `github_files:` = `https://github.com/` (defined in `include/aliases.yml`)
- **New packages**: Go in `elements/bluefin/`, get added as a dependency in `elements/bluefin/deps.bst`
- **Layer composition**: `deps.bst` (stack) -> `layers/bluefin-stack.bst` -> `layers/bluefin-runtime.bst` -> `layers/bluefin.bst` -> `oci/bluefin.bst`
- **Ptyxis** (existing terminal at `elements/core/ptyxis.bst`): Stays alongside Ghostty. Not replaced.
- **Rust pattern** (closest analog for non-standard build system): `kind: manual` with explicit build commands

### Key design decisions (from brainstorming)

| Decision | Rationale |
|---|---|
| Pre-built Zig binary + source tarball | Building Zig from LLVM source would take hours and add massive complexity. Pre-built binary is how every distro packages Zig-built software. |
| `zig fetch` on local files for deps | All 35 deps listed as remote BST sources, fetched by BuildStream. Then `zig fetch` each locally to populate the cache. Fully offline build. |
| `--system` flag for offline build | Tells Zig to use pre-populated cache directory. Disables all network. Required for bubblewrap sandbox. |
| Add alongside Ptyxis, not replacing | Ptyxis is the GNOME-native terminal. Ghostty is an alternative. Users get both. |
| `kind: manual` element | Zig build system is not Meson/Make/Autotools. Manual element with explicit commands. |

---

## Task 1: Extract exact dependency list from Ghostty source

**Files:**
- Reference: Ghostty 1.2.3 source tarball `build.zig.zon`

This is a research task. Before writing the BST element, you need the exact list of all dependency URLs and their Zig content hashes from the Ghostty source.

**Step 1: Download the Ghostty source tarball**

```bash
curl -L -o /tmp/ghostty-1.2.3.tar.gz https://release.files.ghostty.org/1.2.3/ghostty-1.2.3.tar.gz
```

**Step 2: Extract `build.zig.zon` and the dependency manifest**

```bash
tar xf /tmp/ghostty-1.2.3.tar.gz -C /tmp/ ghostty-1.2.3/build.zig.zon
cat /tmp/ghostty-1.2.3/build.zig.zon
```

Also check for a `build.zig.zon.txt` or `build.zig.zon2` file which some Zig projects use to list URL+hash mappings:

```bash
tar tf /tmp/ghostty-1.2.3.tar.gz | grep -i 'zig.zon'
```

**Step 3: Extract every dependency URL and hash**

From `build.zig.zon`, extract every `.url` and `.hash` pair. These are Zig package manager entries. Each URL needs to become a BST `remote` source, and each hash is used by `zig fetch` to place the content correctly.

The format in `build.zig.zon` looks like:
```zig
.foo = .{
    .url = "https://example.com/foo-1.0.tar.gz",
    .hash = "1220abcdef...",
},
```

Record every URL and hash pair. You will need all of them for Task 2.

**Step 4: Document the complete list**

Write the full list of (name, URL, hash) tuples. There should be approximately 35 dependencies. This list is the input for the BST element's sources section.

---

## Task 2: Create the Zig compiler element

**Files:**
- Create: `elements/bluefin/zig.bst`

The Zig compiler is a build-only dependency. It's a self-contained binary tarball that just needs to be unpacked.

**Step 1: Write the element**

Create `elements/bluefin/zig.bst`:

```yaml
kind: manual

sources:
  - kind: tar
    url: https://ziglang.org/download/0.14.1/zig-x86_64-linux-0.14.1.tar.xz
    ref: 24aeeec8af16c381934a6cd7d95c807a8cb2cf7df9fa40d359aa884195c4716c

depends:
  - freedesktop-sdk.bst:public-stacks/runtime-minimal.bst

variables:
  strip-binaries: ""

config:
  install-commands:
    - install -Dm755 zig "%{install-root}%{bindir}/zig"
    - mkdir -p "%{install-root}%{libdir}/zig"
    - cp -r lib/* "%{install-root}%{libdir}/zig/"
```

> **NOTE**: The tar source extracts to `zig-x86_64-linux-0.14.1/`. BuildStream may handle the top-level directory automatically. Verify the extracted layout and adjust paths if needed. The Zig binary is at the root of the extracted dir, and `lib/` contains the standard library.

**Step 2: Verify the element parses**

```bash
just bst show bluefin/zig.bst
```

Expected: Element details printed without errors.

**Step 3: Test build**

```bash
just bst build bluefin/zig.bst
```

Expected: Successful build. The artifact should contain `/usr/bin/zig` and `/usr/lib/zig/`.

**Step 4: Commit**

```bash
git add elements/bluefin/zig.bst
git commit -m "feat: add Zig 0.14.1 compiler element for Ghostty build"
```

---

## Task 3: Create the Ghostty element

**Files:**
- Create: `elements/bluefin/ghostty.bst`

This is the main element. It uses `kind: manual` with:
- Ghostty source tarball as the primary source
- All 35 Zig dependencies as additional `remote` sources
- Zig compiler as a build dependency
- GTK4/libadwaita as runtime dependencies

**Step 1: Write the element skeleton**

Create `elements/bluefin/ghostty.bst`. The structure is:

```yaml
kind: manual

sources:
  # Primary source: Ghostty source tarball
  - kind: tar
    url: https://release.files.ghostty.org/1.2.3/ghostty-1.2.3.tar.gz
    # ref: <sha256 of tarball -- compute from downloaded file>

  # Zig dependencies: one remote source per dependency
  # These are placed in the source directory by BuildStream.
  # The install-commands will zig-fetch each one to populate the cache.
  #
  # IMPORTANT: Replace this section with the actual 35 dependencies
  # extracted in Task 1. Each entry looks like:
  - kind: remote
    url: <dependency-url-from-build.zig.zon>
    ref: <sha256-of-downloaded-file>
    filename: <descriptive-name>.tar.gz
    directory: zig-deps

build-depends:
  - bluefin/zig.bst

depends:
  - freedesktop-sdk.bst:public-stacks/runtime-minimal.bst
  # GTK4, libadwaita, and other GNOME runtime deps
  - gnome-build-meta.bst:sdk/gtk.bst
  - gnome-build-meta.bst:sdk/libadwaita.bst

variables:
  strip-binaries: ""

config:
  build-commands:
    # Set up Zig cache directory
    - export ZIG_GLOBAL_CACHE_DIR="/tmp/zig-cache"
    - mkdir -p "$ZIG_GLOBAL_CACHE_DIR/p"

    # Populate Zig dependency cache from pre-fetched tarballs
    # zig fetch computes the content hash and places files in p/<hash>/
    - |
      for dep in zig-deps/*.tar.gz; do
        zig fetch "$dep" || true
      done

    # Build Ghostty with offline mode
    - |
      ZIG_GLOBAL_CACHE_DIR=/tmp/zig-cache \
      zig build \
        --prefix /usr \
        --system /tmp/zig-cache/p \
        -Doptimize=ReleaseFast \
        -Dcpu=baseline \
        -Dpie=true

  install-commands:
    - |
      ZIG_GLOBAL_CACHE_DIR=/tmp/zig-cache \
      DESTDIR="%{install-root}" \
      zig build \
        --prefix /usr \
        --system /tmp/zig-cache/p \
        -Doptimize=ReleaseFast \
        -Dcpu=baseline \
        -Dpie=true \
        install
    - "%{install-extra}"
```

> **CRITICAL NOTES FOR IMPLEMENTER:**
>
> 1. The `remote` sources section above is a template. You MUST replace it with the actual 35 dependencies from Task 1. Each dependency needs its own `remote` source with the correct URL, SHA256 ref, and a unique filename.
>
> 2. The `directory: zig-deps` directive tells BuildStream to place all remote sources into a `zig-deps/` subdirectory within the source checkout. This keeps them separate from the Ghostty source.
>
> 3. The `zig fetch` loop iterates over all downloaded tarballs and registers them in the Zig cache. The `|| true` is defensive -- some tarballs may already be cached.
>
> 4. The build and install may need to be a single step (Zig build does both). Check Ghostty's PACKAGING.md for the exact install command. The Arch PKGBUILD uses `DESTDIR=... zig build ... install`.
>
> 5. Runtime dependencies (GTK4, libadwaita, etc.) may need adjustment. Check what Ghostty actually links against. The Arch PKGBUILD lists: `gtk4`, `libadwaita-1.so`, `fontconfig`, `freetype2`, `libpng`, `harfbuzz`, `oniguruma`, `pixman`. Some of these are vendored by Zig, some need system libraries.
>
> 6. The `ref:` for the Ghostty source tarball must be computed: `sha256sum /tmp/ghostty-1.2.3.tar.gz`

**Step 2: Verify the element parses**

```bash
just bst show bluefin/ghostty.bst
```

**Step 3: Test build**

```bash
just bst build bluefin/ghostty.bst
```

This will be the first real test. Expect iterations -- the Zig offline build may need adjustments to:
- How `zig fetch` handles local files (path format)
- Whether `--system` path is correct
- Whether all 35 deps are accounted for
- Whether system library dependencies are satisfied

**Step 4: Commit**

```bash
git add elements/bluefin/ghostty.bst
git commit -m "feat: add Ghostty 1.2.3 terminal emulator element"
```

---

## Task 4: Register Ghostty in the dependency stack

**Files:**
- Modify: `elements/bluefin/deps.bst`

**Step 1: Add Ghostty to deps.bst**

Add `bluefin/ghostty.bst` to the `depends:` list in `elements/bluefin/deps.bst`:

```yaml
depends:
  - gnome-build-meta.bst:gnomeos-deps/deps.bst

  - bluefin/gnome-shell-extensions.bst

  - bluefin/brew.bst
  - bluefin/brew-tarball.bst
  - bluefin/ghostty.bst

  - bluefin/common.bst
  - bluefin/wallpapers.bst
  # ... rest unchanged
```

**Step 2: Verify the full build target resolves**

```bash
just bst show oci/bluefin.bst
```

Expected: Ghostty appears in the dependency graph.

**Step 3: Build the full image**

```bash
just build
```

Expected: Full OCI image builds successfully with Ghostty included.

**Step 4: Commit**

```bash
git add elements/bluefin/deps.bst
git commit -m "feat: add Ghostty to Bluefin package set"
```

---

## Task 5: Validate Ghostty in the image

**Step 1: Boot the image**

```bash
just show-me-the-future
```

**Step 2: Verify Ghostty is installed**

In the VM, check:
```bash
which ghostty
ghostty --version
```

Expected: Ghostty 1.2.3 is installed and reports its version.

**Step 3: Verify Ghostty launches**

In the VM's GNOME session, launch Ghostty from the application menu or run `ghostty` from an existing terminal. Verify it opens a GPU-accelerated terminal window.

**Step 4: Verify Ptyxis still works**

Confirm Ptyxis (the existing terminal) is still installed and functional. Both terminals should coexist.

---

## Task 6: Update AGENTS.md and commit

**Files:**
- Modify: `AGENTS.md`

**Step 1: Add Ghostty to the repository layout description**

In the `elements/bluefin/` description in AGENTS.md, add Ghostty alongside the existing packages:

```
  bluefin/               Bluefin-specific packages (brew, fonts, extensions, ghostty, etc.)
```

**Step 2: Commit everything**

```bash
git add AGENTS.md
git commit -m "docs: document Ghostty in AGENTS.md"
```

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| `zig fetch` doesn't work with local files in sandbox | Low | High | Verified: `zig fetch` accepts local file paths. If issues arise, manually unpack tarballs to hash-named directories. |
| Missing system library dependencies | Medium | Medium | Ghostty vendors most deps via Zig. If it needs system libs (oniguruma, pixman), add them as BST dependencies from freedesktop-sdk. |
| Zig binary incompatible with sandbox glibc | Low | High | The pre-built Zig is statically linked (musl). Should work in any Linux environment. |
| `--system` path format wrong | Medium | Medium | Test iteratively. The path should point to the directory containing hash-named subdirs. |
| BuildStream `remote` source handling | Medium | Medium | If `remote` sources don't support `directory:` grouping, use `local` sources with a pre-fetch script, or list each as a separate `tar` source. |
| Ghostty links against wrong GTK version | Low | Medium | gnome-build-meta provides GTK4. Verify Ghostty's pkg-config requirements match. |

## Open Questions

1. **Exact `zig fetch` invocation**: Does `zig fetch ./path/to/dep.tar.gz` work, or does it need `file://` prefix? Test in Task 3.
2. **BuildStream `remote` source with `directory:`**: Does the `remote` source kind support the `directory` attribute to group files? If not, alternative is to use `tar` sources that extract to known paths.
3. **Desktop file**: Does Ghostty install a `.desktop` file automatically, or does it need manual installation? Check the Ghostty source tree for `com.mitchellh.ghostty.desktop` or similar.
4. **Icon/appdata**: Same question for icons and appstream metadata.
5. **Shell integration**: Ghostty ships shell integration scripts. Verify they're installed to the correct location.

## References

- Ghostty PACKAGING.md: https://github.com/ghostty-org/ghostty/blob/main/PACKAGING.md
- Zig build system docs: https://ziglang.org/documentation/0.14.1/
- Arch PKGBUILD for Ghostty: https://gitlab.archlinux.org/archlinux/packaging/packages/ghostty
- Nix derivation: https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/gh/ghostty/package.nix
- BuildStream manual element: https://docs.buildstream.build/2.0/elements/manual.html
